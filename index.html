<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zip To Preview</title>
    <style>

    </style>
    <link rel="stylesheet" href="css/dropzone.css">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="wrapper">
        <div class="sidebar">
            <div class="logo-wrapper">
                <a href="#">
                    <img src="img/logo_200x200.png" alt="logo">
                </a>
            </div>

        </div><!--.sidebar-->
        <div>
            <label>
                <input id="github-url" placeholder="Your github repository url" type="text">
                <a id="generate" onclick="generateFromGithub()">Generate tree for github repository</a>
            </label>
        </div>
        <div class="content">

            <div id="zone">
                <form action="/file-upload"
                      class="dropzone"
                      id="my-awesome-dropzone"></form>
            </div>
        </div><!--.content-->

    </div>
    <script src="js/dropzone.js"></script>
    <script src="js/jszip.js"></script>
    <script src="js/jszip-utils.min.js"></script>
    <script>
        var unzip = new JSZip();
        var reader = new FileReader();

        function generateFromGithub() {
            var githubUrl = 'http://cors-anywhere.herokuapp.com/'; 
            githubUrl += document.getElementById('github-url').value;
            githubUrl += '/archive/master.zip';
            // TODO add githubUrl validator;

            JSZipUtils.getBinaryContent(githubUrl, function(err, data) {
                if (err) {
                    throw err; // or handle err
                }

                unzip
                    .loadAsync(data)
                    .then(function(data2) {
                        processFile(data2);
                    });
            });
        }

        function toTree(filesList) {
            var tree = [];
            var nestLevel = 0;

            filesList.forEach(file => {
                var isFolder = file.endsWith('/'); 
                var filePaths = file.split('/');

                if (filePaths.length < nestLevel ) {
                    nestLevel--;
                }

                if (isFolder) {
                    tree.push({
                        path: filePaths[nestLevel],
                        nestLevel
                    });
                    nestLevel ++;
                } else {
                    tree.push({
                        path: filePaths[filePaths.length - 1],
                        nestLevel
                    });
                }
            });
            return tree;
        }

        function processFile(zip) {
            var fileNames = Object.keys(zip.files);
            var fileNamesTree = toTree(fileNames);

            var height = fileNames.length * 30 + 50;
            var canvasElement = document.createElement('canvas');

            canvasElement.setAttribute('id', 'tree-canvas');
            document.getElementById('zone').replaceWith(canvasElement);

            var canvas = document.getElementById('tree-canvas'); 
            canvas.width = 400;
            canvas.height = height;

            var context = canvas.getContext("2d");
            context.imageSmoothingEnabled = true;
            context.webkitImageSmoothingEnabled = true;
            context.mozImageSmoothingEnabled = true;

            context.fillRect(0, 0, canvas.width, height);

            fileNamesTree.forEach(function (filename, index) {
                context.beginPath();
                context.fillStyle = "#00FA00";
                context.font = "20px Arial, Helvetica, sans-serif";
                context.fillText(filename.path, 25 + filename.nestLevel *  20, 32 * index + 30);
            })
        }

        function readFile(file) {
            reader.readAsBinaryString(file);

            reader.onload = function(file) {
                unzip
                    .loadAsync(file.target.result)
                    .then(function (zip) {
                        processFile(zip);
                    });
            };
        }

        Dropzone.options.myAwesomeDropzone = {
            paramName: "file",
            maxFiles: 1,
            maxFilesize: 2,
            accept: function(file, done) {
                if (file.name.endsWith(".zip")) {
                    done();
                    processFile(file);
                    return;
                } else {
                    done("Only .zip files accepted.");
                }
            },
            init: function() {
                this.on("addedfile", function() {
                    if (this.files[1] != null){
                        this.removeFile(this.files[0]);
                    }
                });
                this.on("error", function(file, message, xhr) {
                    if (this.files[1] != null){
                        this.removeFile(this.files[0]);
                    }
                });
            }
        };
    </script>
</body>
</html>